(function(n){n.widget("webui.search",{_results:n("<div><\/div>"),_resultsList:n("<ul><\/ul>"),_timeoutHandle:null,options:{clearIcon:"fa-times",advancedSearchIcon:"fa-binoculars",dataSource:"",valueName:"",textName:"",parameterName:"fragment",minimumCharactersForSearch:1,delayBeforeSearch:250,requestData:{}},_getMyOptions:function(){return n.extend({},this.options,this.element.data())},_clearResults:function(){this._resultsList.empty();this._hideResults()},_repositionResults:function(){var n=this.element.offset();this._results.css("left",n.left+"px");this._results.css("top",n.top+this.element.outerHeight()-1+"px");this._results.css("min-width",this.element.outerWidth()+"px")},_hideResults:function(){this._results.hide();this.element.removeClass("open")},_showResults:function(t){var i,r,u,f;if(t){var e=this._getMyOptions(),o=e.textName,s=e.valueName;if(this._clearResults(),i=this,t.length===0)this._resultsList.append(n('<div class="list-group-item">No results found<\/li>'));else for(r=0;r<t.length;++r){u=t[r];f=n('<a href="#" class="list-group-item" data-text="'+u[o]+'" data-value="'+u[s]+'">'+u[o]+"<\/li>");this._resultsList.append(f);f.on("click",function(t){t.preventDefault();i._onClick({text:n(t.target).data("text"),value:n(t.target).data("value")});i._hideResults()})}this._results.off("keydown").on("keydown",function(n){var t;n.keyCode===27?(i._clearResults(),i._hideResults()):n.keyCode===38?(t=i._resultsList.find("a:focus").prev(),t.length===0&&(t=i._resultsList.find("a").last()),t.focus()):n.keyCode===40&&(t=i._resultsList.find("a:focus").next(),t.length===0&&(t=i._resultsList.find("a").first()),t.focus())})}this._repositionResults();this._results.show();this.element.addClass("open")},_onClick:function(n){this._trigger("selecting",null,n);this.element.val(n.text);this._trigger("selected",null,n)},_isValidKey:function(n){switch(n){case 13:case 16:case 17:case 20:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:return!1;default:return!0}},_loadData:function(t){var i,r,u;t=t||this._getMyOptions();t.dataSource&&(i=t.requestData,typeof t.requestData=="string"&&t.requestData.length>0?i=JSON.parse(t.requestData):typeof t.requestData=="function"&&(i=t.requestData(this)),typeof t.dataSource=="string"?(r={},r[t.parameterName]=this.element.val(),r=n.extend(r,i),u=this,n.getJSON(t.dataSource,r).done(function(n){u._showResults(n)})):typeof t.dataSource=="function"?this._showResults(t.dataSource(this.element.val(),i)):typeof t.dataSource=="object"&&this._showResults(t.dataSource))},_create:function(){var i=this._getMyOptions(),o=this.element.parent(),t=this,r,u,f,e;if(this._results=n('<div class="search-results" id="'+this.element.prop("id")+'Results"><\/div>'),this._resultsList=n('<div class="search-results-list list-group"><\/div>').appendTo(this._results),this._hideResults(),n("body").append(this._results),i.clearIcon||i.advancedSearchIcon){if(r=n('<div class="input-group"><\/div>'),u=n('<div class="input-group-btn"><\/div>'),i.clearIcon){f=n('<a href="#" class="btn btn-default"><i class="fa fa-fw '+i.clearIcon+'"><\/i><\/a>');u.append(f);f.on("click",function(){t._trigger("clearing");t.element.val("");t._clearResults();t._hideResults();t._trigger("cleared")})}if(i.advancedSearchIcon){e=n('<a href="#" class="btn btn-default"><i class="fa fa-fw '+i.advancedSearchIcon+'"><\/i><\/a>');u.append(e);e.on("click",function(){t._trigger("showadvanced")})}this.element.remove();o.append(r);r.append(this.element);r.append(u);this.element.attr("autocomplete","off");this.element.on("focus",function(){t._resultsList&&t._resultsList.children().length!==0&&t._showResults()});this.element.on("keyup",function(n){if(n.keyCode===40&&t._resultsList.children().first().focus(),n.keyCode===27){t._clearResults();t._hideResults();return}if(t._isValidKey(n.keyCode)&&!n.altKey&&!n.ctrlKey){var r=t.element.val();if(r.length===0){t._clearResults();return}r.length<i.minimumCharactersForSearch||(i.delayBeforeSearch?(this._timeoutHandle&&clearTimeout(this._timeoutHandle),this._timeoutHandle=setTimeout(function(){t._loadData(i)},i.delayBeforeSearch)):t._loadData())}});n(window).on("resize",function(){t._repositionResults()});n(document).on("mouseup",function(n){!t._results.is(":visible")||t._results.is(n.target)||t.element.is(n.target)||t._results.has(n.target).length!==0||t._hideResults()})}},select:function(n,t){this._onClick({text:n,value:t})}})})(jQuery);