Search=function(n,t,i,r,u,f,e,o,s){this._elementId=n.id;this._serviceUrl=t;this._service=i;this._idKey=r;this._valueKey=u;this._itemSelected=null;this._item=null;this._context=null;this._showSelectedText=e;this._isInternetViewerRequest=o;this._securityArea=s;this._Params={};Event.addListener(n,"keyup",this._onKeyUp,this);Event.addListener(n,"keydown",this._onKeyDown,this);Event.addListener(n,"change",this._onBlur,this);this._results=f?new SearchResults(n,f):new SearchResults(n);this._results.onSelected=this.onClickItem.getCallback(this);this._results.onClosing=this.onCloseList.getCallback(this)};Search.prototype.getElement=function(){return $(this._elementId)};Search.prototype.getContext=function(){return this._context};Search.prototype.changeContext=function(n){this._context=n};Search.prototype.onItemSelected=Function.Empty;Search.prototype.onTextChange=function(){};Search.prototype.onLostFocus=function(){};Search.prototype.onClosing=function(){};Search.prototype.onClickItem=function(n,t){this._results.hide();this._itemSelected=t[this._idKey];this._item=t;this._hasSelection=!0;this.getElement().focus();this.onItemSelected(t[this._idKey],t)};Search.prototype.onCloseList=function(){this._hasSelection==!1&&this.onClosing()};Search.prototype.isModifierKeyPressed=function(n){var t=n.altKey,i=n.ctrlKey;return t||i};Search.prototype._isValidKey=function(n){switch(n){case 13:case 16:case 17:case 20:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:return!1;default:return!0}};Search.prototype.onShowResults=Function.empty;Search.prototype._onBlur=function(){if(this._showSelectedText&&this._itemSelected&&$(this._elementId).value){$(this._elementId).value=this._item[this._valueKey];this.onLostFocus(this._itemSelected)}else if(!this._results._isVisible)this.onLostFocus(0)};Search.prototype._onKeyDown=function(n){n.keyCode==13&&n.preventDefault()};Search.prototype.getSearchParameters=function(){this._Params={searchFragment:this.getElement().value}};Search.prototype.verifySearchParameters=function(){return this._Params.searchFragment==this.getElement().value};Search.prototype._onKeyUp=function(n){var i;if(n.keyCode==40&&this._results.selectFirst(),n.keyCode==27){this._results.clear();this._results.hide();return}if(this._isValidKey(n.keyCode)&&!this.isModifierKeyPressed(n)){if(this.onTextChange(),i=$(this._elementId),i.value.length==0){this._results.clear();return}var t=this,u=function(n){var r,f,u;if(!t.verifySearchParameters()){r={};t.getSearchParameters();t._Params&&(r=t._Params);typeof r.isInternetViewerRequest=="undefined"&&(r.isInternetViewerRequest=t._isInternetViewerRequest);t._securityArea!=="undefined"&&(r.securityAreaId=t._securityArea);t._context&&(r.schoolId=t._context.value||t._context.getValue());r.searchFragment!=null&&r.searchFragment.trim().length>0?jQuery.getJSON(t._serviceUrl+"/"+t._service,r,arguments.callee):(Element.removeClass(i,"processing"),t._isProcessing=!1);return}for(f=[],u=0;u<n.length;u++)f[u]={searchResult:n[u],text:n[u][t._valueKey]};t.onShowResults(t._results.show(f));Element.removeClass(i,"processing");t._isProcessing=!1},r=function(){if(!t._isProcessing){t._isProcessing=!0;t._hasSelection=!1;Element.appendClass(i,"processing");var n={};t.getSearchParameters();t._Params&&(n=t._Params);typeof n.isInternetViewerRequest=="undefined"&&(n.isInternetViewerRequest=t._isInternetViewerRequest);t._securityArea!=="undefined"&&(n.securityAreaId=t._securityArea);t._context&&(n.schoolId=t._context.value||t._context.getValue());n.searchFragment=i.value;n.searchFragment!=null&&n.searchFragment.trim().length>0?jQuery.getJSON(t._serviceUrl+"/"+t._service,n).done(u):(Element.removeClass(i,"processing"),t._isProcessing=!1)}};t._Timer||(t._Timer=new Timer,t._Timer.lastRequestTime=new Date);(new Date).getTime()-t._Timer.lastRequestTime.getTime()<500&&(t._Timer.lastRequestTime=new Date,t._Timer.clear(),t._Timer.setTimeout(r,500));t._Timer.setTimeout(r,500)}};SearchResults=function(n,t){this._elementId=n.id+"_searchResults";this._parentElementId=n.id;this._selectedIndex=0;this._isVisible=!1;var i=this.getElement();Element.hide(i);t?document.forms[0].appendChild(i):Element.insertAfter(i,n)};SearchResults.prototype.getElement=function(){var n=$(this._elementId);return n?n:(n=document.createElement("div"),n.id=this._elementId,Element.appendClass(n,"searchResults"),n)};SearchResults.prototype._onKeyDown=function(n){var t,i;n.stopPropagation();t=$(this._listId).getElementsByTagName("a");switch(n.keyCode){case 9:n.shiftKey?this._selectedIndex--:this._selectedIndex++;n.preventDefault();break;case 13:i=t[this._selectedIndex];this.onSelected(i,i.searchResult);n.preventDefault();break;case 40:this._selectedIndex++;this._selectedIndex==t.length&&(this._selectedIndex=0);t[this._selectedIndex].focus();n.preventDefault();break;case 38:this._selectedIndex--;this._selectedIndex==-1&&(this._selectedIndex=t.length-1);t[this._selectedIndex].focus();n.preventDefault();break;case 27:this.clear();this.hide()}};SearchResults.prototype.clear=function(){for(var n=this.getElement(),i=n.getElementsByTagName("a"),t=0;t<i.length;t++)Event.removeListener(i[t],"click",this.onClickItem,this);n.innerHTML="";this._selectedIndex=0;Element.hide(n)};SearchResults.prototype.render=function(n){var i,f,t,e,s,u;for(this.clear(),i=document.createElement("div"),f=this.getElement(),this._listId=f.id+"_List",i.id=this._listId,i.className="list-group",f.appendChild(i),Event.addListener(i,"keydown",this._onKeyDown,this),e=0;e<n.length;e++){t=document.createElement("a");Element.appendClass(t,"list-group-item");i.appendChild(t);var r=n[e],o=r.searchResult,h=!1;o&&o.type&&o.type==1&&(h=!0);o.disabled?(s=document.createElement("label"),Element.appendClass(s,"Disable"),Element.setInnerText(s,r.text),t.appendChild(s)):(u=t,h&&Element.appendClass(u,"ShowIcon"),u.href="#",u.searchResult=r.searchResult,u.title=r.text,Event.addListener(u,"click",this.onClickItem,this),Element.setInnerText(u,r.text+(r.searchResult.schoolName?" at "+r.searchResult.schoolName:"")))}n.length===0&&(t=document.createElement("div"),t.className="list-group-item",Element.setInnerText(t,"No results"),i.appendChild(t));Element.show(f)};SearchResults.prototype.onSelected=Function.empty;SearchResults.prototype.onClosing=Function.empty;SearchResults.prototype.onClickItem=function(n){n.preventDefault();this.onSelected(n.target,n.target.searchResult)};SearchResults.prototype._onDocumentClick=function(){this.clear();this.hide();this.onClosing();Event.removeListener(document,"click",this._onDocumentClick,this)};SearchResults.prototype.show=function(n){var t=this.getElement();return this.render(n),this._isVisible=!0,Event.addListener(document,"click",this._onDocumentClick,this),t};SearchResults.prototype.hide=function(){Element.hide(this.getElement());this._isVisible=!1};SearchResults.prototype.selectFirst=function(n){var i=n||this.getElement(),t=i.getElementsByTagName("a");t[0]&&t[0].focus&&t[0].focus()};