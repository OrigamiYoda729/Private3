(function(n){SessionReminder=function(n,t,i,r){this._watcherId=n;this._sessionId=r;this._syncTimer=new Timer;this._expirationTimer=new Timer;this._countdownTimer=new Timer;this.BASE_URL="/";this.SERVICE_URL="Common/SessionReminder.ashx/Update";this.LOGOUT_URL="Logon.aspx";t!=null&&(this.BASE_URL=t);this._promptDelay=60;i!=null&&(this._promptDelay=i);this._options={path:"/"}};SessionReminder._cookieName="SessionReminder";SessionReminder.prototype.reset=function(n){this._form&&this._form.modal("hide");this.stop();this.start(n)};SessionReminder.prototype.renewConnection=function(){var t=this,i=function(n){t.reset(n.nextExpiration)},r=function(){};n.ajax({success:i,error:r,type:"POST",url:this.BASE_URL+this.SERVICE_URL,dataType:"json",async:!0})};SessionReminder.prototype.renew_onClick=function(n){n.data.context.renewConnection()};SessionReminder.prototype.logout_onClick=function(n){n.data.context.forceLogout()};SessionReminder.prototype.createPrompt=function(){var t=n('\t\t\t<div class="modal SessionReminder" id="inactivityModal" tabindex="-1" role="dialog" aria-labelledby="inactivityModalLabel">\t\t\t\t<div class="modal-dialog modal-sm" role="document">\t\t\t\t\t<div class="modal-content">\t\t\t\t\t\t<div class="modal-header">\t\t\t\t\t\t\t<h4 class="modal-title" id="inactivityModalLabel">Inactivity Notice<\/h4>\t\t\t\t\t\t<\/div>\t\t\t\t\t\t<div class="modal-body">\t\t\t\t\t\t<\/div>\t\t\t\t\t\t<div class="modal-footer">\t\t\t\t\t\t<\/div>\t\t\t\t\t<\/div>\t\t\t\t<\/div>\t\t\t<\/div>').appendTo("body").attr("id",this._watcherId),r=t.find(".modal-body"),i;return r.append("\t\t\t<p>Due to inactivity, your session will soon close. Click the 'Stay signed in' button below to continue your session.<\/p>\t\t\t<p>If no action is taken, you will be signed out.<\/p>\t\t\t<p>Your session will close in <strong class=\"countdown\"><\/strong>.<\/p>"),i=t.find(".modal-footer"),i.append('\t\t\t<button type="button" class="btn btn-default" data-dismiss="modal" data-action="logout">Sign out now<\/button>\t\t\t<button type="button" class="btn btn-primary" data-dismiss="modal" data-action="renew">Stay signed in<\/button>'),t.find("[data-action=renew]").click({context:this},this.renew_onClick),t.find("[data-action=logout]").click({context:this},this.logout_onClick),t};SessionReminder.prototype.updateCountdown=function(){var t=new Date;n("div.SessionReminder .countdown").text(new Timespan(this._storedExpiration.getTime()-t.getTime()).toReadableString());t<this._storedExpiration&&this._countdownTimer.setTimeout(this.updateCountdown.bind(this),1e3)};SessionReminder.prototype.promptUser=function(){this._form==null&&(this._form=this.createPrompt());this._form.modal();this._countdownTimer.setTimeout(this.updateCountdown.bind(this),0)};SessionReminder.prototype.assureCookie=function(){var t=n.cookie(SessionReminder._cookieName);return t==null&&(t=this._storedExpiration,n.cookie(SessionReminder._cookieName,this._storedExpiration,this._options)),t};SessionReminder.prototype.updateCookie=function(t){this.assureCookie();n.cookie(SessionReminder._cookieName,t,this._options)};SessionReminder.prototype.synchronizeSharedExpiration=function(){var i=n.cookie(SessionReminder._cookieName),t;if(!i){this._form&&this._form.modal("hide");this.stop();this.lock();return}t=new Date(i);t>this._storedExpiration&&(this._storedExpiration=t,this._form&&this._form.modal("hide"),this.stop(),this._syncTimer.setTimeout(this.synchronizeSharedExpiration.bind(this),0),this._expirationTimer.setTimeout(this.checkExpiration.bind(this),1e3));this._syncTimer.setTimeout(this.synchronizeSharedExpiration.bind(this),1e3)};SessionReminder.prototype.forceLogout=function(){this.stop();n.cookie(SessionReminder._cookieName,null,this._options);document.location.href=this.BASE_URL+this.LOGOUT_URL+"?Action=logout"};SessionReminder.prototype.lock=function(){this.stop();n.cookie(SessionReminder._cookieName,null,this._options);document.location.href=this.BASE_URL+this.LOGOUT_URL+"?Action=lock&token="+this._sessionId+"&ReturnUrl="+encodeURIComponent(document.location.href)};SessionReminder.prototype.showLogoutMessage=function(){var t=n(".SessionReminder"),i=t.find(".modal-body"),r;i.empty();i.append('<p>Your session has expired. Click <a href="#" role="button" onclick="location.reload(); return false;">here<\/a> to log on again.<\/p>');r=t.find(".modal-footer");r.remove();t.modal()};SessionReminder.prototype.checkExpiration=function(){var n=new Date(this._storedExpiration.getTime()),t;n.setSeconds(n.getSeconds()-this._promptDelay);t=new Date;t>this._storedExpiration?this.lock():t>n?(this._expirationTimer.setTimeout(this.checkExpiration.bind(this),1e3),this.promptUser()):this._expirationTimer.setTimeout(this.checkExpiration.bind(this),1e3)};SessionReminder.prototype.start=function(n){var t=new Date;t.setMinutes(t.getMinutes()+n);this._storedExpiration=t;this.updateCookie(t);this._syncTimer.setTimeout(this.synchronizeSharedExpiration.bind(this),0);this._expirationTimer.setTimeout(this.checkExpiration.bind(this),1e3)};SessionReminder.prototype.stop=function(){this._expirationTimer.clear();this._syncTimer.clear();this._countdownTimer.clear()}})(jQuery);